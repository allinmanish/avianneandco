<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category   design_default
 * @package    Mage
 * @copyright  Copyright (c) 2008 Irubin Consulting Inc. DBA Varien (http://www.varien.com)
 * @license    http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<?php
/**
 * Temlate for Mage_Customer_Block_Address_Book block
 * @var $test Mage_Customer_Block_Address_Book
 */
?>
<div class="account">
<div class="logout cf"><a class="btn btn-logout" href="<?php echo Mage::helper('customer')->getLogoutUrl(); ?>"><?php echo $this->__('Log Out'); ?></a></div>
<div class="my-account-box cf">
	<?php echo $this->getMessagesBlock()->getGroupedHtml() ?>
	<?php echo $this->getChildHtml('hello') ?>
<div class="account-box ad-account-info">
    <div class="col-1 primary-address-list">
        <h4><?php echo $this->__('Default Addresses') ?></h4>
        <ol class="acount-addresses">
        	<?php if($_pAddsses = Mage::getSingleton('customer/session')->getCustomer()->getDefaultBilling()): ?>
            <li>
                <h5><?php echo $this->__('Default Billing Address') ?></h5>
                <address>
                <?php echo $this->getAddressHtml(Mage::getSingleton('customer/session')->getCustomer()->getAddressById($_pAddsses)) ?><br/>
                <a class="form-button" href="<?php echo $this->getAddressEditUrl(Mage::getSingleton('customer/session')->getCustomer()->getAddressById($_pAddsses)) ?>"><span><?php echo $this->__('Change Billing Address') ?></span></a></address>
           </li>
           <?php elseif($_pAddsses = Mage::getSingleton('customer/session')->getCustomer()->getDefaultShipping()): ?>
           <li>
                <h5><?php echo $this->__('Default Billing Address') ?></h5>
                <address>
                    <?php echo $this->getAddressHtml(Mage::getSingleton('customer/session')->getCustomer()->getAddressById($_pAddsses)) ?><br/>
                    <a class="form-button" href="<?php echo $this->getAddressEditUrl(Mage::getSingleton('customer/session')->getCustomer()->getAddressById($_pAddsses)) ?>"><span><?php echo $this->__('Change Billing Address') ?></span></a>
                </address>
            </li>
            <?php else: ?>
            <li>
                <h5><?php echo $this->__('Default Billing Address') ?></h5>
                <?php echo $this->__('You have no default billing address in your address book.') ?>
            </li>
            <?php endif ?>
            <?php if($_pAddsses = Mage::getSingleton('customer/session')->getCustomer()->getDefaultShipping()): ?>
            <li>
                <h5><?php echo $this->__('Default Shipping Address') ?></h5>
                <address>
                    <?php echo $this->getAddressHtml(Mage::getSingleton('customer/session')->getCustomer()->getAddressById($_pAddsses)) ?><br/>
                    <a class="form-button" href="<?php echo $this->getAddressEditUrl(Mage::getSingleton('customer/session')->getCustomer()->getAddressById($_pAddsses)) ?>"><span><?php echo $this->__('Change Shipping Address') ?></span></a></strong>
                </address>
            </li>
            <?php elseif($_pAddsses = Mage::getSingleton('customer/session')->getCustomer()->getDefaultBilling()): ?>
            <li>
                <h5><?php echo $this->__('Default Shipping Address') ?></h5><address>
                <?php echo $this->getAddressHtml(Mage::getSingleton('customer/session')->getCustomer()->getAddressById($_pAddsses)) ?><br/>
                <a class="form-button" href="<?php echo $this->getAddressEditUrl(Mage::getSingleton('customer/session')->getCustomer()->getAddressById($_pAddsses)) ?>"><span><?php echo $this->__('Change Shipping Address') ?></span></a>
                </address>
            </li>
            <?php else: ?>
            <li>
                <h5><?php echo $this->__('Default Shipping Address') ?></h5>
                <?php echo $this->__('You have no default shipping address in your address book.') ?>
            </li>
            <?php endif ?>
        </ol>
    </div>
    <div class="col-2 address-list">
        <h4><?php echo $this->__('Additional Address Entries') ?></h4>
        <ol>
        <?php if($_pAddsses = $this->getAdditionalAddresses()): ?>
            <?php foreach($_pAddsses as $_address): ?>
            <li>
                <address>
                    <?php echo $this->getAddressHtml($_address) ?><br/>
                    <a href="<?php echo $this->getUrl('customer/address/edit', array('id'=>$_address->getId())) ?>"><span><?php echo $this->__('Edit Address') ?></span></a>
                    <a href="#" onclick="return deleteAddress('<?php echo $_address->getId() ?>');" class="link-remove"><span><?php echo $this->__('Delete Address') ?></span></a>
                </address>
            </li>
            <?php endforeach; ?>
        <?php else: ?>
            <li> <?php echo $this->__('You have no additional address entries in your address book.') ?></li>
        <?php endif ?>
        </ol>
    </div>
    <button type="button" class="form-button" onclick="window.location='<?php echo $this->getAddAddressUrl() ?>';"><span><?php echo $this->__('Add New Address') ?></span></button>
</div>
</div>
<?php $viewed = $this->getChildHtml('recently_viewed');?>
<?php if ($viewed == '<!--product_viewed_start--><!--product_viewed_end-->'): ?>
<div class="account-viewed product-box-list">
			<?php 
				$_addprods_ids = array(); $i=0;
				$db = Mage::getSingleton('core/resource')->getConnection('core_read');
				$result = $db->query("SELECT i.product_id, v.value AS product_url
										FROM sales_flat_order_item i
										LEFT JOIN catalog_product_entity_varchar v ON i.product_id = v.entity_id
										WHERE v.attribute_id =570
										AND v.store_id =0
										ORDER BY i.created_at DESC 
										LIMIT 0 , 2");
				while ($row = $result->fetch(PDO::FETCH_ASSOC)) {
					$_addprods_ids[$i]['id'] = $row['product_id'];
					$_addprods_ids[$i]['url'] = $row['product_url'];
					$i++;
				}

				for ($i=0; $i<(2-count($_products)); $i++) {
					$_item = Mage::getModel('catalog/product')->load($_addprods_ids[$i]['id']);
					$_url = $_addprods_ids[$i]['url'] ? $_addprods_ids[$i]['url'] : $_item->getProductUrl(); ?>
					<ul class="account-navigation">
						<li><?php echo $this->__('Recently Viewed'); ?></li>
					</ul>
					<div class="item">
						<p class="product-image">					
							<a href="<?php echo $_item->getProductUrl() ?>" title="<?php echo $this->htmlEscape($_item->getName()) ?>"> 
					            <img src="<?php echo $this->helper('catalog/image')->init($_item, 'small_image')->constrainOnly(TRUE)->keepAspectRatio(TRUE)->keepFrame(FALSE)->setQuality(75)->resize(186); ?>"  width="186" height="186" alt="<?php echo $this->htmlEscape($_item->getName()) ?>" />
					        </a>
						</p>
						<center>
							<h5>
								<a href="<?php echo $_item->getProductUrl() ?>" title="<?php echo $this->htmlEscape($_item->getName()) ?>"><?php echo $this->htmlEscape($_item->getName()) ?></a>
							</h5>
							<?php echo Mage_Catalog_Block_Product::getPriceHtml($_item, true);  ?>
						</center>
					</div>
					<?php 
				} ?>
</div>
<?php else: ?>
	<?php echo $viewed; ?>
<?php endif; ?>
<script type="text/javascript">
//<![CDATA[
    function deleteAddress(addressId) {
        if(confirm('<?php echo $this->__('Are you sure you want to delete this address?') ?>')) {
            window.location='<?php echo $this->getDeleteUrl() ?>id/'+addressId;
        }
        return false;
    }
//]]>
</script>
</div>